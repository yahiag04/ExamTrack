<%- include('../partials/header', { title: 'Area Studente - ExamTrack' }) %>

<div class="container py-4">
  <div class="row justify-content-center mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center">
          <div>
            <h1 class="h4 fw-bold mb-1">
              Area Studente
            </h1>
            <% if (studente) { %>
              <p class="mb-0 small text-muted">
                <strong><%= studente.nome %> <%= studente.cognome %></strong><br />
                Matricola: <%= studente.matricola %><br />
                <% if (studente.corso) { %>
                  Corso di laurea: <%= studente.corso %>
                <% } %>
              </p>
            <% } %>
          </div>
          <div class="mt-3 mt-md-0 text-md-end">
            <% if (typeof media !== 'undefined') { %>
              <div class="small text-muted">Media voti</div>
              <div class="fs-4 fw-bold text-primary">
                <%= media %>
              </div>
            <% } %>

            <div class="small text-muted">
              CFU: <strong><%= cfuTotali %> / 180</strong>
            </div>

            <% if (typeof totTentativi !== 'undefined') { %>
              <div class="small text-muted">
                Esami svolti: <strong><%= totTentativi %></strong>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
<!-- tabella dei voti-->
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 fw-bold mb-0">Storico esami</h2>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
              <i class="bi bi-journal-check me-1"></i>
              <%= tentativi && tentativi.length ? tentativi.length : 0 %> record
            </span>
          </div>

          <% if (!tentativi || tentativi.length === 0) { %>
            <p class="text-muted small mb-0">
              Non sono ancora presenti esami registrati.
            </p>
          <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Corso</th>
                    <th class="text-center">Voto</th>
                    <th class="text-center">Tipo</th>
                    <th class="text-center">Esito</th>
                    <th class="text-center">Tentativi</th>
                    <th class="text-center">Data</th>
                    <th class="text-center">Azione</th>
                  </tr>
                </thead>
                <tbody>
                  <% tentativi.forEach(t => { %>
                    <tr>
                      <td>
                        <span class="fw-semibold"><%= t.nome_insegnamento %></span>
                      </td>

                      
                      <td class="text-center">
                        <% if (t.voto === null || typeof t.voto === 'undefined') { %>
                          <span class="text-muted small">N/D</span>
                        <% } else { %>
                          <span class="fw-semibold"><%= t.voto %></span>
                        <% } %>
                      </td>

                      
                      <td class="text-center">
                        <% if (t.tipo_tentativo === 'completo') { %>
                          <span class="badge bg-primary-subtle text-primary border border-primary-subtle small">
                            Completo
                          </span>
                        <% } else if (t.tipo_tentativo === 'parziale') { %>
                          <span class="badge bg-warning-subtle text-warning border border-warning-subtle small">
                            Parziale
                          </span>
                        <% } else { %>
                          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle small">
                            <%= t.tipo_tentativo %>
                          </span>
                        <% } %>
                      </td>

                     
                      <td class="text-center">
                        <% if (t.esito_finale === 'superato') { %>
                          <span class="badge bg-success-subtle text-success border border-success-subtle small">
                            Superato
                          </span>
                        <% } else if (t.esito_finale === 'non_superato') { %>
                          <span class="badge bg-danger-subtle text-danger border border-danger-subtle small">
                            Non superato
                          </span>
                        <% } else { %>
                          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle small">
                            N/A
                          </span>
                        <% } %>
                      </td>

                      
                      <td class="text-center">
                        <span class="small">
                          <%= t.numero_tentativi || 1 %>
                        </span>
                      </td>

                      
                      <td class="text-center">
                        <% if (t.data_svolgimento) { %>
                          <span class="small text-muted">
                            <%= new Date(t.data_svolgimento).toLocaleDateString('it-IT') %>
                          </span>
                        <% } else { %>
                          <span class="small text-muted">N/D</span>
                        <% } %>
                      </td>

                      <!-- AZIONE -->
                      <td class="text-center">
                        <% 
                          const votoValido = (t.voto !== null && typeof t.voto !== 'undefined');
                          const votoSufficiente = votoValido && t.voto >= 18;
                          const eCompleto = t.tipo_tentativo === 'completo';
                          const nonVerbalizzato = t.verbalizzazione === false;
                          const nonAccettato = (t.accettato !== true);   // <--- CHIAVE
                        %>

                        <% if (eCompleto && votoSufficiente && nonVerbalizzato && nonAccettato && t.esito_finale === 'superato') { %>
                          <!-- Accetta Rifiuta -->
                          <div class="d-flex justify-content-center gap-1">
                            <form method="POST" action="/studente/tentativi/<%= t.id_tentativo %>/accetta">
                              <button type="submit" class="btn btn-sm btn-success">
                                Accetta
                              </button>
                            </form>
                            <form method="POST" action="/studente/tentativi/<%= t.id_tentativo %>/rifiuta">
                              <button type="submit" class="btn btn-sm btn-outline-danger">
                                Rifiuta
                              </button>
                            </form>
                          </div>

                        <% } else if (votoValido && t.voto < 18 && nonVerbalizzato) { %>
                          <!-- Presa visione -->
                          <form method="POST" action="/studente/tentativi/<%= t.id_tentativo %>/presa_visione">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                              Presa visione
                            </button>
                          </form>
                        <% } else { %>
                          <span class="small text-muted">Nessuna azione</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

<div class="row justify-content-center mt-4">
  <div class="col-lg-10">
    <div class="card shadow-sm border-0">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 fw-bold mb-0">Esami verbalizzati</h2>
          <span class="badge bg-success-subtle text-success border border-success-subtle">
            <i class="bi bi-check2-circle me-1"></i>
            <%= esamiVerbalizzati && esamiVerbalizzati.length ? esamiVerbalizzati.length : 0 %> esami
          </span>
        </div>

        <% if (!esamiVerbalizzati || esamiVerbalizzati.length === 0) { %>
          <p class="text-muted small">Non risultano esami verbalizzati.</p>
        <% } else { %>

          <div class="table-responsive">
            <table class="table align-middle table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Corso</th>
                  <th class="text-center">CFU</th>
                  <th class="text-center">Voto</th>
                  <th class="text-center">Data</th>
                  <th class="text-center">Stato</th>
                </tr>
              </thead>

              <tbody>
                <% esamiVerbalizzati.forEach(ev => { %>
                  <tr>

                    <!-- Corso -->
                    <td>
                      <span class="fw-semibold"><%= ev.nome_insegnamento %></span>
                    </td>

                    <!-- CFU -->
                    <td class="text-center">
                      <span class="fw-semibold"><%= ev.cfu %></span>
                    </td>

                    <!-- Voto -->
                    <td class="text-center">
                      <span class="fw-semibold"><%= ev.voto %></span>
                    </td>

                    <!-- Data -->
                    <td class="text-center">
                      <span class="small text-muted">
                        <%= new Date(ev.data_svolgimento).toLocaleDateString('it-IT') %>
                      </span>
                    </td>

                    <!-- Stato -->
                    <td class="text-center">
                      <span class="badge bg-success-subtle text-success border border-success-subtle small">
                        Verbalizzato
                      </span>
                    </td>

                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

        <% } %>

      </div>
    </div>
  </div>
</div>
</div>

<%- include('../partials/footer') %>